# Mapleプロジェクト 状態空間拡張 実装計画

## 目的
- 交代読みやダメージ予測・素早さ関係など、より高度な戦術学習のために状態空間を根本から見直す。

---

## 課題整理
- 相手ポケモンの全6体を把握できない（選出が確定しているポケモンしか識別できない）ため、交代読みが困難。
- 技のダメージ期待値や素早さ関係が状態に含まれていない。
- 変化技の扱いも単純で、AIが有用性を区別できていない。


---

## 改善方針

- チームプレビュー時にお互いの6体すべての「全国図鑑No.」を状態空間に含める（どれが選出されたかは選出フェイズ後のみ判明）。
- バトル中は「自分・相手のアクティブ」と「控え枠（最大2体）」を詳細に表現する。
- 技ごとに「技威力」「技カテゴリ（物理/特殊/変化）」を状態に含める。
- ポケモンごとに「種族値（特に素早さ）」「状態異常」「能力ランク」なども状態に含める。
- ダメージ計算による「技ダメージ期待値」も状態空間に含める。
- 素早さ比較結果（先制可能か）をブールまたは数値で明示する。

---

## 実装ステップ

### 1. ダメージ計算モジュールの作成(Maple/src/damage/caluculator.pyのDamageCaluculatorクラスを拡張)
- 通常のダメージ計算メソッドとは別にAIの状態空間観測用に攻撃側ポケモンの「こうげき」「とくこう」「すばやさ」「おもさ」それぞれの実数値・能力のランク変化・タイプ・テラスタイプ・テラスタルしているかどうか・特性・もちもの・技・相手の名前を入力としてダメージ期待値（割合）を返す関数を用意
- ダメージはx(期待値)±y(分散)で表現して(x,y)を返す(例:45.2~47.8%なら46.5±1.3%)
- 相手のポケモンの名前をキーとして、外部ファイル(`config/pokemon_stats.csv`)から種族値を取得
- 最初の段階として最低限攻撃側の実数値、能力ランク変化、タイプ、テラスタイプ・テラスタルしているかどうかと、相手の種族値、技の一致補正、タイプ相性で計算を行う
- 現時点では各種補正は実装しない
- 計算結果を各技特徴量として状態に含める
- テストプログラムを作成して正しい戻り値が得られるかを確認


### 2. 状態特徴量CSV/YAMLの拡張
- `state_feature_catalog_temp.csv`に
  - 自分6体・相手6体分の全国図鑑No.が記録されるように追加
  - 選出3体分の「アクティブ」「控え1」「控え2」について詳細な状態（HP、状態異常、能力ランク、場の状態など）が記録されるように修正(実装済み)
  - 技ごとの「威力」「カテゴリ」「タイプ」も追加(実装済み)
  - 自分の選出３体のわざそれぞれ->相手の６体へのダメージ概算も特徴量に追加((3(選出３体)x4(わざ4つ)x2(テラスタル有無)x6(相手チームのポケモン数)=144通り)
  - ダメージ概算は(x(期待値),y(分散))で表現。
- `generate_yaml.py`で`state_spec.yml`を再生成

### 3. `StateObserver`の拡張 ✅ **完了**
- `StateObserver._build_context()`で
  - ✅ チームプレビュー情報の全6体名前→全国図鑑No.に変更して保持
  - ✅ 各チーム内インデックス（1〜6番）で管理する。
  - ✅ 自分の選出3体が確定したらアクティブと控えを示す`active_index`,`bench1_index`,`bench2_index`を６匹の中からOne-Hotで表現、あるいはまとめてリスト化
  - ✅ 相手のポケモンは場に見えた（選出が確定した）段階でインデックス・マスクを設定
  - ✅ アクティブ・控え2体の詳細情報は今まで通り保持
  - ✅ 技の威力・カテゴリもいままで通り保持
  - ✅ ダメージ計算モジュールから各技の期待ダメージ値を算出して追加

**実装詳細:**
- `SpeciesMapper`クラスによる効率的なポケモン名→図鑑No.変換システム
- バトルタグ+ターンベースのキャッシュシステムで性能最適化（2μs/回、497k+操作/秒）
- `DamageCalculator`統合による技ダメージ期待値計算
- CSV特徴量数を654→558に削減（96特徴量削減）
- 厳密なエラーハンドリング（フォールバック機能削除）


### 4. データベースとの連携(スキップ)
- 技データ（例: `move_stats.csv`）から技威力・カテゴリ・タイプを取得
- 取得した技名が日本語の場合は`moves_english_japanese.csv`をもとに英語化（poke-envでは基本英語だが、今後情報入力元をSwitch実機の対戦画面などに拡張予定）
- データは`StateObserver`起動時に一度読み込み、インデックス参照可能にする

### 5. 変化技・能力変化・状態異常の特徴量化
- 技カテゴリ（物理/特殊/変化）をOne-Hotで入れる
- ポケモンごとの能力ランク変化、状態異常も特徴量化(実装済み)


### 6. テスト
- 全ての特徴量がCSV→YAML→`StateObserver`で正しく反映されるか検証
- 未確定の特徴量が正しく扱われているかをログに表示して検証（人間に確認させる）
- ダミーデータで観測ベクトルの整合性・次元数を確認
- 学習スクリプトでリセット・観測の動作確認

---

## 注意点・補足

- 相手未選出3体の詳細情報（HPや技等）は見えないが、チームプレビューで分かる「種族・タイプ」は常に状態に入れる。
- バトル中の相手の「控え」は選出が確定された最大3体に限定し、それ以外は常にNone/デフォルト値とする。
- 特徴量が増えるためネットワーク構造の容量調整も検討する（必要に応じて隠れ層数/ユニット増加）。
- 未選出ポケモンの項目はマスクして扱う。

---

## 追加提案

- 特徴量設計が複雑になるため、「状態ベクトル内容」と「ネットワーク入力次元」の関係を常に可視化・テストすること。
- 必要に応じて特徴量の「有用性」をテストし、不要な情報は省略してもよい。

---

【実装後は、交代読みや有利な対面作りなど戦術がAIに学習されやすくなり、従来より深いバトル判断ができるようになる】
