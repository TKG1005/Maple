# çŠ¶æ…‹ç©ºé–“æ­£è¦åŒ–å®Ÿè£…è¨ˆç”»æ›¸

## æ¦‚è¦

çŠ¶æ…‹ç©ºé–“åˆ†æã«ã‚ˆã‚Šã€æ•°å€¤ã‚¹ã‚±ãƒ¼ãƒ«ã®ä¸çµ±ä¸€å•é¡ŒãŒç‰¹å®šã•ã‚Œã¾ã—ãŸã€‚æœ¬è¨ˆç”»æ›¸ã§ã¯ã€å­¦ç¿’åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®æ®µéšçš„æ­£è¦åŒ–å®Ÿè£…ã‚’å®šç¾©ã—ã¾ã™ã€‚

## å•é¡Œã®èƒŒæ™¯

### ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ
- **æ•°å€¤ã‚¹ã‚±ãƒ¼ãƒ«ã®æ··åœ¨**: å›³é‘‘ç•ªå·(1024)ã€å®Ÿæ•°å€¤(158)ã€æ­£è¦åŒ–æ¸ˆã¿ç‰¹å¾´é‡(0-1)ãŒæ··åœ¨
- **å­¦ç¿’åŠ¹ç‡ä½ä¸‹**: ç•°ãªã‚‹ã‚¹ã‚±ãƒ¼ãƒ«ã«ã‚ˆã‚Šå‹¾é…æ›´æ–°ãƒãƒ©ãƒ³ã‚¹ãŒä¸é©åˆ‡
- **åæŸæ€§èƒ½åŠ£åŒ–**: å¤§ããªç‰¹å¾´é‡ãŒå­¦ç¿’ã‚’æ”¯é…ã™ã‚‹ç¾è±¡

### å…·ä½“çš„ãªæ•°å€¤ä¾‹
```
æ­£è¦åŒ–æ¸ˆã¿: HPå‰²åˆ 0.607 (60.7%)
æœªæ­£è¦åŒ–: å›³é‘‘No. 1024 (ãƒ†ãƒ©ãƒ‘ã‚´ã‚¹)  
æœªæ­£è¦åŒ–: å®Ÿæ•°å€¤ 158 (ãƒ«ãƒŠã‚¢ãƒ©ã®ã¨ãã“ã†)
æœªæ­£è¦åŒ–: PP 32 (ã‚ã„ãã†ã®æœ€å¤§PP)
```

## å®Ÿè£…è¨ˆç”»

### Phase 1: å³åº§ä¿®æ­£ (é«˜å„ªå…ˆåº¦) ğŸ”´

**å¯¾è±¡**: ãƒã‚±ãƒ¢ãƒ³å®Ÿæ•°å€¤ã®æ­£è¦åŒ–è¨­å®šå¤‰æ›´

**ä½œæ¥­å†…å®¹**:
1. **config/state_feature_catalog.csv ã®ä¿®æ­£**
   ```csv
   # ä¿®æ­£å¯¾è±¡: ã™ã¹ã¦ã®å®Ÿæ•°å€¤ç‰¹å¾´é‡
   active_base_stats_def,identity â†’ linear_scale,"range:[0,337] scale_to:[0,1]"
   active_base_stats_spa,identity â†’ linear_scale,"range:[0,337] scale_to:[0,1]"  
   active_base_stats_spd,identity â†’ linear_scale,"range:[0,337] scale_to:[0,1]"
   active_base_stats_spe,identity â†’ linear_scale,"range:[0,337] scale_to:[0,1]"
   my_bench1_base_stats_*,identity â†’ linear_scale,"range:[0,337] scale_to:[0,1]"
   my_bench2_base_stats_*,identity â†’ linear_scale,"range:[0,337] scale_to:[0,1]"
   ```

**å½±éŸ¿ç¯„å›²**:
- **ä¿®æ­£å¯¾è±¡**: 12å€‹ã®å®Ÿæ•°å€¤ç‰¹å¾´é‡
- **åŠ¹æœ**: å­¦ç¿’ã®æ•°å€¤å®‰å®šæ€§å³åº§æ”¹å–„
- **ãƒªã‚¹ã‚¯**: æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ã¨ã®äº’æ›æ€§ãªã—ï¼ˆæ–°è¦å­¦ç¿’å¿…è¦ï¼‰

**å®Ÿè£…æ‰‹é †**:
1. `config/state_feature_catalog.csv` ã®encoderåˆ—ã‚’ä¸€æ‹¬å¤‰æ›´
2. StateObserverã®å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
3. æ–°è¦å­¦ç¿’ã§ã®åæŸæ€§èƒ½ç¢ºèª

**å®Œäº†æ¡ä»¶**:
- [ ] å…¨å®Ÿæ•°å€¤ç‰¹å¾´é‡ãŒ0-1ç¯„å›²ã«æ­£è¦åŒ–
- [ ] test_state_space.pyã§æ­£è¦åŒ–ç¢ºèª
- [ ] å­¦ç¿’ãƒ†ã‚¹ãƒˆã§æ•°å€¤å®‰å®šæ€§å‘ä¸Šç¢ºèª

### Phase 2: ä¸­æœŸå¯¾å¿œ (ä¸­å„ªå…ˆåº¦) ğŸŸ¡

**å¯¾è±¡**: Embeddingäº‹å‰å‡¦ç†ã«ã‚ˆã‚‹å›³é‘‘ç•ªå·çµ±åˆ

**æŠ€è¡“æ–¹é‡**:
å›³é‘‘ç•ªå·ã‚’ç›´æ¥æ­£è¦åŒ–ã›ãšã€Species Embeddingã‚’äº‹å‰å‡¦ç†ã—ã¦çŠ¶æ…‹ç©ºé–“ã«çµ±åˆ

**å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**:
```python
# ç¾åœ¨ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼
raw_species_ids â†’ StateObserver â†’ MoveEmbeddingLayer â†’ 32æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«

# æ–°ã—ã„å‡¦ç†ãƒ•ãƒ­ãƒ¼  
raw_species_ids â†’ StateObserver(äº‹å‰Embedding) â†’ æ­£è¦åŒ–æ¸ˆã¿32æ¬¡å…ƒ â†’ çµ±ä¸€ã‚¹ã‚±ãƒ¼ãƒ«çŠ¶æ…‹ç©ºé–“
```

**ä½œæ¥­å†…å®¹**:
1. **StateObserveræ‹¡å¼µ** (`src/env/state_observer.py`)
   ```python
   def _build_context(self):
       # Species Embeddingã®äº‹å‰å‡¦ç†
       species_embeddings = self.species_embedding_layer(raw_species_ids)
       normalized_species = F.normalize(species_embeddings, dim=-1)
       
       # çŠ¶æ…‹ç©ºé–“ã¸ã®çµ±åˆ
       ctx["my_team1_species_embed"] = normalized_species[0]  # 32æ¬¡å…ƒ
       # å›³é‘‘ç•ªå·ãã®ã‚‚ã®ã¯å‰Šé™¤
   ```

2. **SpeciesEmbeddingLayerå®Ÿè£…** (`src/agents/species_embedding_layer.py`)
   ```python
   class SpeciesEmbeddingLayer(nn.Module):
       def __init__(self, vocab_size=1026, embed_dim=32):
           super().__init__()
           self.embedding = nn.Embedding(vocab_size, embed_dim)
           # ç¨®æ—å€¤ã«ã‚ˆã‚‹åˆæœŸåŒ–
           self._init_with_base_stats()
   ```

3. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°**
   ```yaml
   # config/state_spec.yml - å›³é‘‘ç•ªå·ç‰¹å¾´é‡ã‚’å‰Šé™¤
   # my_team1_pokedex_num: å‰Šé™¤
   # ä»£ã‚ã‚Šã«embeddingç‰¹å¾´é‡ã‚’è¿½åŠ 
   my_team1_species_embedding:
     dimensions: 32
     encoder: identity  # æ—¢ã«æ­£è¦åŒ–æ¸ˆã¿  
   ```

**å®Œäº†æ¡ä»¶**:
- [ ] SpeciesEmbeddingLayerã®å®Ÿè£…å®Œäº†
- [ ] StateObserverçµ±åˆå®Œäº†  
- [ ] å›³é‘‘ç•ªå·ã®çŠ¶æ…‹ç©ºé–“ã‹ã‚‰ã®å‰Šé™¤
- [ ] 32æ¬¡å…ƒSpecies Embeddingã®æ­£è¦åŒ–çµ±åˆ
- [ ] å­¦ç¿’æ€§èƒ½ã®ç¶­æŒç¢ºèª

### Phase 3: é•·æœŸæœ€é©åŒ– (ä½å„ªå…ˆåº¦) ğŸŸ¢

**å¯¾è±¡**: PPå€¤ãƒ»ã‚¿ãƒ¼ãƒ³æ•°ã®æ­£è¦åŒ–

**ä½œæ¥­å†…å®¹**:
1. **PPé–¢é€£ç‰¹å¾´é‡**
   ```csv
   *_move*_max_pp,identity â†’ linear_scale,"range:[0,48] scale_to:[0,1]"
   ```

2. **ã‚¿ãƒ¼ãƒ³ãƒ»ã‚«ã‚¦ãƒ³ãƒˆç³»ç‰¹å¾´é‡**
   ```csv
   turn_count,identity â†’ linear_scale,"range:[0,300] scale_to:[0,1]"
   weather_turn,identity â†’ linear_scale,"range:[0,100] scale_to:[0,1]"  
   my_remaining_pokemon,identity â†’ linear_scale,"range:[0,6] scale_to:[0,1]"
   opp_remaining_pokemon,identity â†’ linear_scale,"range:[0,6] scale_to:[0,1]"
   ```

**å®Œäº†æ¡ä»¶**:
- [ ] å…¨PPå€¤ã®æ­£è¦åŒ–å®Œäº†
- [ ] ã‚¿ãƒ¼ãƒ³æ•°ãƒ»ã‚«ã‚¦ãƒ³ãƒˆç³»æ­£è¦åŒ–å®Œäº†
- [ ] å®Œå…¨ãªæ•°å€¤ã‚¹ã‚±ãƒ¼ãƒ«çµ±ä¸€é”æˆ

## æŠ€è¡“ä»•æ§˜

### æ­£è¦åŒ–æ–¹å¼ã®çµ±ä¸€
```python
# linear_scale ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼ä»•æ§˜
def linear_scale(value, min_val, max_val):
    return (value - min_val) / (max_val - min_val)

# é©ç”¨ä¾‹
raw_value = 158  # ãƒ«ãƒŠã‚¢ãƒ©ã®ã¨ãã“ã†å®Ÿæ•°å€¤
normalized = linear_scale(158, 0, 337)  # 0.469
```

### Species Embeddingä»•æ§˜
```python
# EmbeddingåˆæœŸåŒ–ä»•æ§˜
embedding_weights[pokemon_id] = [
    hp_base/255,      # æ­£è¦åŒ–æ¸ˆã¿ç¨®æ—å€¤HP
    attack_base/255,  # æ­£è¦åŒ–æ¸ˆã¿ç¨®æ—å€¤ã“ã†ã’ã  
    defense_base/255, # æ­£è¦åŒ–æ¸ˆã¿ç¨®æ—å€¤ã¼ã†ãã‚‡
    spa_base/255,     # æ­£è¦åŒ–æ¸ˆã¿ç¨®æ—å€¤ã¨ãã“ã†
    spd_base/255,     # æ­£è¦åŒ–æ¸ˆã¿ç¨®æ—å€¤ã¨ãã¼ã†
    speed_base/255,   # æ­£è¦åŒ–æ¸ˆã¿ç¨®æ—å€¤ã™ã°ã‚„ã•
    *learnable_features  # 26æ¬¡å…ƒå­¦ç¿’å¯èƒ½ç‰¹å¾´é‡
]
```

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

### Phase 1 ãƒªã‚¹ã‚¯
- **æ—¢å­˜ãƒ¢ãƒ‡ãƒ«éäº’æ›**: å®Ÿæ•°å€¤æ­£è¦åŒ–ã«ã‚ˆã‚Šæ—¢å­˜checkpointãŒä½¿ç”¨ä¸å¯
- **å¯¾ç­–**: æ–°è¦å­¦ç¿’ã‚’å‰æã¨ã—ãŸè¨ˆç”»ãƒ»ååˆ†ãªæ¤œè¨¼

### Phase 2 ãƒªã‚¹ã‚¯  
- **Embeddingçµ±åˆã®è¤‡é›‘æ€§**: StateObserveræ‹¡å¼µã«ã‚ˆã‚‹è¤‡é›‘åŒ–
- **å¯¾ç­–**: æ®µéšçš„å®Ÿè£…ãƒ»comprehensive testing

### Phase 3 ãƒªã‚¹ã‚¯
- **éåº¦ã®æ­£è¦åŒ–**: æ„å‘³ã®ã‚ã‚‹æ•°å€¤å·®ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§
- **å¯¾ç­–**: å­¦ç¿’æ€§èƒ½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»å¿…è¦ã«å¿œã˜ãŸèª¿æ•´

## æˆæœæŒ‡æ¨™

### æŠ€è¡“æŒ‡æ¨™
- [ ] å…¨ç‰¹å¾´é‡ã®æ•°å€¤ç¯„å›²çµ±ä¸€ (0-1)
- [ ] StateObserverå‡¦ç†æ™‚é–“ < 5msç¶­æŒ
- [ ] å­¦ç¿’åæŸé€Ÿåº¦ã®æ”¹å–„ç¢ºèª

### å­¦ç¿’æ€§èƒ½æŒ‡æ¨™  
- [ ] å­¦ç¿’å®‰å®šæ€§å‘ä¸Š (loss varianceæ¸›å°‘)
- [ ] åæŸé€Ÿåº¦å‘ä¸Š (åŒä¸€episodeæ•°ã§ã®æ€§èƒ½å‘ä¸Š)
- [ ] ãƒãƒˆãƒ«å‹ç‡ç¶­æŒãƒ»å‘ä¸Š

## å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```
Week 1: Phase 1å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆ
Week 2-3: Phase 2è¨­è¨ˆãƒ»å®Ÿè£…  
Week 4: Phase 2ãƒ†ã‚¹ãƒˆãƒ»çµ±åˆ
Week 5-6: Phase 3å®Ÿè£…ãƒ»æœ€çµ‚æ¤œè¨¼
```

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `config/state_feature_catalog.csv` - ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼è¨­å®šå¤‰æ›´
- `src/env/state_observer.py` - Embeddingçµ±åˆ
- `src/agents/species_embedding_layer.py` - æ–°è¦å®Ÿè£…

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«  
- `test_state_space.py` - æ­£è¦åŒ–ç¢ºèªç”¨
- `tests/test_state_observer.py` - StateObserverå‹•ä½œç¢ºèª
- `tests/test_species_embedding.py` - Embeddingå‹•ä½œç¢ºèª

---

**ä½œæˆæ—¥**: 2025-07-24  
**æœ€çµ‚æ›´æ–°**: 2025-07-24  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 1-4 å®Œå…¨å®Ÿè£…å®Œäº† ğŸ†

## è¿½åŠ å®Ÿè£…è¨˜éŒ²

### Phase 4 å®Ÿè£…å®Œäº† (2025-07-24)

#### å¯¾è±¡: æŠ€å‘½ä¸­ç‡ãƒ»ãƒ™ãƒ³ãƒãƒã‚±ãƒ¢ãƒ³å®Ÿæ•°å€¤ã®æœ€çµ‚æ­£è¦åŒ–

**å®Ÿè£…ã•ã‚ŒãŸç‰¹å¾´é‡**:

**æŠ€å‘½ä¸­ç‡ (12å€‹ç‰¹å¾´é‡)**:
- `active_move1_acc` ~ `active_move4_acc`: `[0,1] â†’ [0,1]` çµ±ä¸€
- `my_bench1_move1_acc` ~ `my_bench1_move4_acc`: `[0,1] â†’ [0,1]` çµ±ä¸€  
- `my_bench2_move1_acc` ~ `my_bench2_move4_acc`: `[0,1] â†’ [0,1]` çµ±ä¸€

**ãƒ™ãƒ³ãƒãƒã‚±ãƒ¢ãƒ³å®Ÿæ•°å€¤ (8å€‹ç‰¹å¾´é‡)**:
- `my_bench1_base_stats_def/spa/spd/spe`: `[0,337] â†’ [0,1]` æ­£è¦åŒ–
- `my_bench2_base_stats_def/spa/spd/spe`: `[0,337] â†’ [0,1]` æ­£è¦åŒ–

#### å®Œäº†æ¡ä»¶é”æˆçŠ¶æ³
- [x] å…¨æŠ€å‘½ä¸­ç‡ç‰¹å¾´é‡ã®è¨­å®šçµ±ä¸€å®Œäº†
- [x] å…¨ãƒ™ãƒ³ãƒãƒã‚±ãƒ¢ãƒ³å®Ÿæ•°å€¤ã®æ­£è¦åŒ–å®Œäº†
- [x] test_phase4_normalization.py ã«ã‚ˆã‚‹åŒ…æ‹¬çš„æ¤œè¨¼é€šé
- [x] çŠ¶æ…‹ç©ºé–“å…¨ä½“ã®æ•°å€¤ã‚¹ã‚±ãƒ¼ãƒ«å®Œå…¨çµ±ä¸€é”æˆ

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œå…¨é”æˆ
**å…¨Phaseçµ±åˆåŠ¹æœ**:
- Phase 1-4ã®æ®µéšçš„å®Ÿè£…ã«ã‚ˆã‚Šå…¨æ•°å€¤ç‰¹å¾´é‡ãŒ0-1ç¯„å›²ã«çµ±ä¸€
- å¼·åŒ–å­¦ç¿’ã®æ•°å€¤å®‰å®šæ€§ã¨å­¦ç¿’åŠ¹ç‡ãŒæœ€é©åŒ–ãƒ¬ãƒ™ãƒ«ã«åˆ°é”
- ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã®ä½¿ç”¨æº–å‚™å®Œäº†

**æŠ€è¡“çš„æˆæœ**:
- å®Œå…¨ãªæ•°å€¤ã‚¹ã‚±ãƒ¼ãƒ«çµ±ä¸€ã«ã‚ˆã‚‹å‹¾é…æµæœ€é©åŒ–
- å…¨ç‰¹å¾´é‡ã®å…¬å¹³ãªå­¦ç¿’å¯„ä¸ãƒãƒ©ãƒ³ã‚¹å®Ÿç¾
- åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å“è³ªä¿è¨¼ã¨ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ 

ğŸŠ **çŠ¶æ…‹ç©ºé–“æ­£è¦åŒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œå…¨é”æˆ** ğŸŠ