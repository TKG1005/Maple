# Node.js IPC Battle Server 開発計画書

## 概要

WebSocket通信を完全に排除し、IPCによる高速バトル処理を実現するNode.js IPCサーバーの完全実装計画。
Node.jsプロセス部分とIPC通信部分をあわせてMapleShowdownCoreと命名

### 前提要件

- Node.jsプロセスは、オリジナルのPokemon Showdownサーバーの動作をトレースし、メッセージフォーマット・シーケンスを完全に再現して送受信すること  
- IPCサーバーは、既存のWebSocket通信機能を最小限に置き換えることを目的とし、可能な限りShowdown準拠のNode.jsプロセスおよびpoke-env（EnvPlayer相当）の仕様をそのまま活用すること
- 🚨 **不完全情報ゲーム要件**: 各プレイヤーが独立したBattleオブジェクトを持ち、MapleShowdownCoreがプレイヤー固有のメッセージを適切に振り分けること
- **通信仕様**: Node.jsはエラーメッセージをstderrに、IPCプロトコルメッセージとShowdownメッセージをJSON形式でstdoutに出力
- **メッセージ識別**: IPCプロトコルメッセージには`type`フィールドで識別子を付与、Showdownメッセージは`{"type": "protocol", "data": "..."}`形式でラップ
- **互換性保持**: Showdownオリジナルメッセージは変更を加えずにpoke-envに渡される  


## 段階的開発計画

### Phase A: Pokemon Showdown正確な仕様理解・統合 (4-6日)

#### A.1: BattleStream 統合と IPC メッセージ処理 (2-3日)
実行済み

#### A.2: チームデータ受け渡しロジック (1-2日)
実行済み

#### A.3: エラーハンドリング・ログ改善 (1日)
実行済み

### Phase B: 完全Battle Protocol実装 (5-7日)

#### B.1: Showdownプロトコル生メッセージ転送 (2-3日)
**目標**: BattleStreamから出力される生のShowdownプロトコルメッセージをそのまま転送し、Python側のpoke-env標準処理に委任

**作業内容**:
1. **Showdownプロトコルメッセージの転送**
   - BattleStreamからの複数行メッセージを改行で結合した1つの文字列として処理
   - 最初の行は必ず`>battle-format-id`形式のバトルタグ
   - 形式：`{"type": "protocol", "data": ">battle-format-id\n|init|battle\n..."}`
   - プレイヤー固有メッセージには`player_id`フィールドを追加
   - すべてのメッセージをstdoutにJSON形式で出力
   - `|request|`メッセージには`rqid`が含まれることを保証



#### B.2: バトル終了判定 
**目標**: Pythonクライアントとの完全同期

**作業内容**:

1. **バトル終了判定**
   - 勝敗の確定
   - 

**成果物**:
- リアルタイム進行システム
- イベントドリブン状態管理
- バトル終了処理

#### B.3: パフォーマンス最適化・測定 (1日)
**目標**: 通信レイテンシ最適化

**作業内容**:
1. **通信レイテンシ最適化**
   - JSON serialization/deserializationの最適化
   - バッファリング戦略
   - 無駄な通信の排除

2. **メモリ使用量最適化**
   - オブジェクトプールの活用
   - 不要データの適切なクリーンアップ
   - GC圧力の最小化

3. **包括的パフォーマンステスト**
   - WebSocket vs IPC比較測定
   - 大量並列実行テスト
   - 長時間実行安定性テスト

**成果物**:
- 最適化されたIPCサーバー
- パフォーマンス比較レポート
- ベンチマーク自動化スクリプト

### Phase C: プロダクション準備・最終統合 (2-3日)

#### C.1: 最終統合テスト・バグ修正 (1-2日)
**目標**: 全機能の統合動作確認

**作業内容**:
1. **エンドツーエンドテスト**
   - train.py完全実行テスト
   - 全学習アルゴリズムでの動作確認
   - エラーケースの網羅的テスト

2. **互換性テスト**
   - 既存WebSocketモードとの結果比較
   - 学習結果の一貫性確認
   - poke-env互換性の確認

3. **最終バグ修正**
   - 残存する不具合の解決
   - エッジケースの処理
   - 性能問題の最終調整

**成果物**:
- 完全動作するシステム
- 包括的テストレポート
- バグ修正履歴

#### C.2: ドキュメント・運用準備 (1日)
**目標**: 運用・保守のための情報整備

**作業内容**:
1. **運用ドキュメント**
   - セットアップ・設定手順
   - トラブルシューティングガイド
   - パフォーマンス調整方法

2. **開発者ドキュメント**
   - アーキテクチャ詳細説明
   - 拡張・カスタマイズ方法
   - APIリファレンス

3. **品質保証**
   - コードレビュー・リファクタリング
   - セキュリティチェック
   - 最終性能測定

**成果物**:
- 完全なドキュメント群
- 運用ツール・スクリプト
- 品質保証レポート


#### 進捗追跡 (PROGRESS.md)
