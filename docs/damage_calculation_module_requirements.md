# ダメージ計算モジュール要求定義書

## 1. 概要

本ドキュメントは、MapleプロジェクトにおけるポケモンバトルAIのためのダメージ計算モジュールの要求仕様を定義する。
このモジュールは、バトル中の様々な状況を考慮して、技が与えるダメージを正確に計算し、また、AIエージェントのためのシミュレーション機能を提供することを目的とする。

## 2. 機能要件

### 2.1. 入力情報

ダメージ計算を実行するために、以下の情報が必要となる。

#### 2.1.1. 攻撃側ポケモンの情報

- 名前
- タイプ（1, 2）
- 特性
- 実数値（レベル, HP, こうげき, ぼうぎょ, とくこう, とくぼう, すばやさ）
- ランク変化（こうげき, ぼうぎょ, とくこう, とくぼう, すばやさ, 命中率, 回避率）
- 持ち物
- 使用する技
- 覚えている技（最大4つ）
- テラスタイプ
- テラスタル状態（している/していない）
- 状態異常

#### 2.1.2. 防御側ポケモンの情報

- 名前
- タイプ（1, 2）
- 特性
- 実数値（レベル, HP, こうげき, ぼうぎょ, とくこう, とくぼう, すばやさ）
- ランク変化（こうげき, ぼうぎょ, とくこう, とくぼう, すばやさ, 命中率, 回避率）
- 持ち物
- テラスタイプ
- テラスタル状態（している/していない）
- 状態異常
- まもる状態フラグ
- リフレクターフラグ
- ひかりのかべフラグ
- はねやすめフラグ

#### 2.1.3. 場の情報

- 天候（はれ, あめ, すなあらし, あられ, ゆき）
- フィールド（エレキ, グラス, ミスト, サイコ）
- 重力状態
- ワンダールーム状態

#### 2.1.4. 相手ポケモンの実数値が不明な場合の仕様

対戦相手のポケモンの実数値（努力値や性格）は不確定情報であるため、以下の仕様を満たすこと。

1.  **努力値パターンの自動計算:** ポケモン名から種族値データを参照し、複数の代表的な努力値配分（例: HP特化, 攻撃特化, 素早さ特化など）に基づいたダメージをそれぞれ計算し、結果を並べて表示する。
2.  **手動入力インターフェース:** ユーザーが相手のポケモンの性格、努力値、個体値などを手動で設定し、その値に基づいてダメージ計算を実行できる機能を提供する。
3.  上記1と2の機能を両方提供し、ユーザーは状況に応じて使い分けることができる。

### 2.2. 出力情報（人間向け）

計算結果は、以下の形式で出力する。

#### 2.2.1. 計算結果の表示形式

- **ダメージ範囲:** 乱数によるダメージの振れ幅（最小ダメージ〜最大ダメージ）を表示する。
- **HP割合:** ダメージ範囲が、相手の最大HPに対してどのくらいの割合になるかをパーセンテージで表示する。
- **確定数:** その技で相手を倒すために必要な攻撃回数の目安（例: 「確定1発」「乱数2発 (50%)」「確定3発」など）を表示する。

**表示例:**
```
ダメージ: 120 〜 140
HP割合: 45.5% 〜 52.8% (乱数2発)
```

#### 2.2.2. 計算内訳の表示

ユーザーがダメージ計算の根拠を理解できるよう、計算過程の詳細を表示するオプションを提供する。

**表示例:**
```
【計算内訳】
- タイプ相性: x2.0 (効果は抜群だ！)
- 急所: なし
- 攻撃側補正:
  - 特性(ちからもち): x2.0
  - 持ち物(こだわりハチマキ): x1.5
- 防御側補正:
  - 特性(もふもふ): x0.5 (接触技)
- 天候: 晴れ (ほのお技威力x1.5)
```

### 2.3. AIエージェント向け機能

AIエージェントが手の検索（行動評価）を行うために、確率的な事象を解決し、単一の結果を返すメソッドを提供する。

#### 2.3.1. メソッドの機能

このメソッドは、2.1で定義された入力情報に基づき、以下の処理を実行する。

1.  **命中判定:** 技の命中率、場の状態、双方の命中・回避ランクを考慮して、技が命中したかどうかを判定する。
2.  **ダメージ計算:** 命中した場合、ダメージ計算式と乱数（0.85〜1.0）に基づいて、単一のダメージ値を決定する。
3.  **追加効果判定:** 技に設定された追加効果の発動確率に基づき、効果が発動したかどうかを判定する。

#### 2.3.2. メソッドの返り値

メソッドは、以下の情報を含むオブジェクトまたは辞書を返す。

- **命中:** (True / False)
- **ダメージ:** (整数値) ※命中しなかった場合は0
- **急所:** (True / False)
- **追加効果:**
  - **発動:** (True / False)
  - **内容:** (発動した場合、具体的な効果を示す文字列。例: 「相手をやけど状態にした」「相手のぼうぎょランクを1段階下げた」)

### 2.4. データ管理

- ポケモンの種族値、技の威力や分類、特性の効果、持ち物の効果、タイプ相性表などの静的なデータは、外部ファイル（CSV形式またはYAML形式）で管理する。
- 本モジュールは、これらの外部ファイルを読み込んで、計算に必要なデータを取得する機能を持つ。
- この構成により、将来的なゲームバージョンのアップデート（新ポケモン、新技の追加など）に伴うデータ更新を、コードの変更なしに容易に行えるようにする。
